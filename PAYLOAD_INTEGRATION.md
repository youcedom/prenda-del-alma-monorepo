# Payload CMS 3.x + Next.js 15 + React 19 Integration Guide

This document records the specific challenges, errors, and solutions encountered while integrating Payload CMS 3.0 (Beta/RC) into a Next.js 15 monorepo with React 19.

## 1. Stack Compatibility Matrix
*   **Next.js**: `15.4.10` (Strict requirement: Payload peer dependency is often `^15.4.10`. Do not use `latest` / v16 yet).
*   **React**: `19.0.0` (Supported, but requires strict version pinning).
*   **Payload**: `3.x` / `latest`.
*   **Package Manager**: `pnpm` (Recommended for monorepos).

---

## 2. Critical Errors & Solutions

### A. The "ue() is undefined" / "Cannot destructure property 'config'" Crash
**Symptoms:**
*   Admin panel fails to load.
*   Next.js Error Overlay shows `TypeError: Cannot destructure property 'config' of 'ue(...)' as it is undefined`.
*   Stack trace points to `CodeEditor`, `Upload`, or `RichText` components.

**Root Cause:**
*   **Missing React Context**: Payload's UI components depend on a global `ConfigContext` and `ServerFunctionsContext`.
*   **Missing Layout**: The Admin routes were rendering using a generic Next.js `RootLayout` instead of the required Payload-specific layout wrapper.

**The Fix:**
You must create a dedicated layout file for Payload routes that injects the configuration.

**File:** `apps/backend/src/app/(payload)/layout.tsx`
```typescript
import config from '../../../payload.config'
import '@payloadcms/next/css'
import { handleServerFunctions, RootLayout } from '@payloadcms/next/layouts'
// Import map is generated by Payload, ensuring server components check this path
import { importMap } from './admin/importMap' 
import React from 'react'
import { ServerFunctionClient } from 'payload'

// Required Bridge for Server Functions (Payload 3.x specific)
const serverFunction: ServerFunctionClient = async function (args) {
  'use server'
  return handleServerFunctions({
    ...args,
    config,
    importMap,
  })
}

const Layout = ({ children }: { children: React.ReactNode }) => (
  <RootLayout config={config} importMap={importMap} serverFunction={serverFunction}>
    {children}
  </RootLayout>
)
export default Layout
```

### B. "ServerFunctionsProvider requires a serverFunction prop"
**Symptoms:**
*   Admin panel loads partially but crashes with `Error: ServerFunctionsProvider requires a serverFunction prop`.

**Root Cause:**
*   The `<RootLayout>` component was used but the `serverFunction` prop was omitted. Payload 3.x requires this prop to bridge client-side interactions with server-side logic (Local API).

**The Fix:**
*   Implement the `serverFunction` (as shown in the code block above) and pass it to `<RootLayout>`.

### C. "validateDOMNesting" / Hydration Mismatches
**Symptoms:**
*   Console error: `validateDOMNesting(...): <html> cannot appear as a child of <body>`.
*   Admin panel looks broken or unstyled.

**Root Cause:**
*   **Double Root Layouts**: The `src/app/layout.tsx` (generic) was wrapping `src/app/(payload)/layout.tsx` (Payload). Both render `<html>` and `<body>` tags.

**The Fix: Multiple Root Layouts**
Restructure the application to use Route Groups so that Payload and the Frontend have completely separate root layouts.

**Structure:**
```text
src/app/
├── (payload)/       <-- Route Group 1
│   ├── admin/       <-- Admin routes
│   └── layout.tsx   <-- Payload Root Layout (renders html/body)
└── (frontend)/      <-- Route Group 2
    ├── page.tsx     <-- Home page
    └── layout.tsx   <-- Website Root Layout (renders html/body)
```
*Note: Ensure `src/app/layout.tsx` does NOT exist.*

### D. "MetadataBoundary" / Build Cache Staleness
**Symptoms:**
*   Build fails with `Could not find the module ... MetadataBoundary`.

**Root Cause:**
*   Moving layout files (e.g. into `(frontend)`) confuses Next.js's incremental build cache.

**The Fix:**
*   `rm -rf .next` (Delete the build artifacts)
*   Restart server.

---

## 3. Dependency Management (Monorepo)
**Issue:**
*   Monorepos often install multiple versions of React (e.g., `18.x` for legacy, `19.x` for new).
*   Payload UI (Client Components) will crash if there are duplicate React instances.

**The Fix:**
Enforce a single React version using `pnpm.overrides` (or `resolutions` in yarn/npm) in the **root** `package.json`.

```json
// root package.json
{
  "pnpm": {
    "overrides": {
      "react": "19.0.0",
      "react-dom": "19.0.0",
      "@monaco-editor/react": "^4.7.0" // Ensure Monaco matches React 19
    }
  }
}
```

## 4. Configuration Requirements
**Missing `next.config.mjs`**
Payload requires the `withPayload` plugin to inject environment variables and build aliases.

**File:** `apps/backend/next.config.mjs`
```javascript
import { withPayload } from '@payloadcms/next/withPayload'

/** @type {import('next').NextConfig} */
const nextConfig = {
  // Strict mode can double-invoke effects, disable if debugging race conditions
  reactStrictMode: false, 
}

export default withPayload(nextConfig)
```
